
# coding: utf-8

# In[ ]:

import pandas as pd
tickers = u"600006,600008,600017,600021,600022,600026,600037,600039,600053,600056,600058,600060,600062,600064,600073,600079,600094,600098,600120,600125,600126,600138,600141,600143,600151,600155,600158,600160,600161,600166,600167,600169,600171,600179,600183,600195,600201,600216,600258,600259,600260,600266,600267,600277,600280,600282,600291,600298,600307,600312,600315,600316,600317,600325,600329,600335,600338,600348,600350,600373,600376,600380,600388,600392,600393,600409,600410,600416,600418,600426,600428,600435,600458,600460,600466,600478,600486,600497,600499,600500,600507,600511,600515,600521,600525,600528,600536,600545,600549,600557,600563,600565,600567,600572,600575,600580,600582,600584,600597,600598,600611,600623,600633,600639,600640,600642,600643,600645,600648,600649,600657,600664,600673,600694,600699,600707,600717,600718,600729,600737,600739,600745,600748,600750,600751,600754,600755,600757,600759,600763,600765,600770,600777,600779,600782,600787,600801,600804,600808,600811,600820,600823,600827,600835,600839,600845,600848,600859,600862,600863,600869,600872,600874,600875,600879,600881,600884,600885,600895,600901,600903,600908,600909,600917,600939,600959,600967,600970,600971,600978,600985,600993,600996,601000,601001,601003,601005,601016,601019,601068,601098,601100,601106,601118,601127,601128,601139,601168,601179,601200,601231,601311,601326,601333,601608,601611,601615,601678,601689,601699,601717,601718,601777,601801,601811,601866,601869,601872,601880,601928,601958,601966,601969,603000,603025,603056,603077,603198,603225,603228,603233,603328,603355,603369,603377,603444,603486,603501,603515,603517,603556,603568,603569,603650,603659,603712,603766,603806,603816,603866,603868,603877,603883,603885,603888,603939,000006,000008,000009,000012,000021,000025,000027,000028,000031,000039,000060,000061,000062,000066,000078,000089,000090,000156,000158,000301,000400,000401,000426,000488,000501,000513,000519,000528,000536,000537,000541,000543,000547,000552,000559,000563,000564,000581,000587,000598,000600,000623,000636,000681,000685,000686,000690,000712,000717,000718,000723,000727,000729,000732,000738,000750,000758,000761,000766,000778,000807,000813,000826,000829,000830,000848,000860,000869,000877,000878,000883,000887,000926,000930,000932,000937,000959,000960,000970,000975,000980,000983,000987,000988,000990,000997,000998,000999,002002,002004,002019,002028,002030,002038,002048,002049,002051,002056,002064,002074,002075,002078,002085,002092,002093,002110,002118,002127,002128,002129,002131,002152,002155,002157,002174,002176,002183,002191,002195,002212,002217,002221,002223,002233,002242,002244,002249,002250,002251,002254,002266,002268,002273,002280,002281,002285,002299,002302,002317,002332,002340,002344,002353,002358,002366,002368,002371,002372,002373,002375,002382,002384,002385,002387,002390,002399,002405,002407,002408,002414,002416,002419,002424,002426,002431,002434,002437,002439,002440,002444,002463,002465,002470,002482,002489,002491,002500,002503,002505,002506,002507,002509,002512,002517,002544,002572,002573,002583,002589,002603,002607,002635,002640,002665,002670,002672,002681,002690,002699,002701,002707,002709,002745,002797,002807,002812,002815,002818,002821,002831,002839,002916,002920,002926,002936,002941,002946,002948,300001,300002,300009,300010,300026,300027,300055,300058,300088,300113,300115,300133,300134,300159,300166,300168,300182,300197,300199,300207,300244,300253,300257,300266,300274,300287,300297,300308,300315,300316,300324,300376,300383,300418,300450,300459"

dates = [u"20160104",u"20160201",u"20160301",u"20160401",u"20160503",u"20160601",u"20160701",u"20160801",u"20160901",u"20161010",u"20161101",u"20161201",u"20170103",u"20170203",u"20170301",u"20170405",u"20170502",u"20170601",u"20170703",u"20170801",u"20170901",u"20171009",u"20171101",u"20171201",u"20180102",u"20180201",u"20180301",u"20180402",u"20180502",u"20180601",u"20180702",u"20180801",u"20180903",u"20181008",u"20181101",u"20181203",u"20190102",u"20190201",u"20190301",u"20190401",u"20190506",u"20190603"]

#前1个月涨跌幅，日均换手率
df1 = DataAPI.MktEqumGet(secID=u"",ticker=tickers,monthEndDate=u"",beginDate=u"20160101",endDate=u"20190630",isOpen=u"",field=u"ticker,monthBeginDate,exchangeCD,avgTurnoverRate,chgPct",pandas="1")
df1.rename(columns={'monthBeginDate':'tradeDate'},inplace=True)


# In[ ]:

index = 1
for day in dates:
    df_temp = pd.DataFrame(columns=['ticker'])
#总市值，流通市值，市盈率,市净率
    df2 = DataAPI.MktEqudGet(secID=u"",ticker=tickers,tradeDate=day,beginDate=u"",endDate=u"",isOpen="",field=u"ticker,tradeDate,marketValue,negMarketValue,PE,PB",pandas="1")

#分析师
    df3 = DataAPI.MktStockFactorsOneDayGet(tradeDate=day,secID=u"",ticker=tickers,field=u"ticker,FY12P,PCF,NetAssetGrowRate,VSTD10,MACD,RSI,ROE,plusDI,minusDI,ADX,ASI,Hurst",pandas="1")

    df4 = DataAPI.EquIndustryGet(secID=u"",ticker=tickers,industryVersionCD=u"",industry=u"",industryID=u"",industryID1=u"",industryID2=u"",industryID3=u"",intoDate=day,field=u"ticker,industryID1",pandas="1")
    
    df4 = df4.dropna(subset=['industryID1'])
    df4['dup'] = df4.duplicated(subset=['ticker'], keep='first')
    first = 0
    print("enter for loop")
    for i in range(0,len(df4)):
        curr = df4.iloc[i]
        indName = curr['industryID1']
        if indName not in df4.columns:
            df4[indName] = 0
        if curr['dup'] == False:
            first = i
        df4.iloc[first, df4.columns.get_loc(indName)] = 1

    print(day)
    df4 = df4[df4['dup'] == False]
    df4 = df4.drop('dup',axis = 1)
            
    
    df_temp = df_temp.merge(df2,how='outer',on='ticker')
    df_temp = df_temp.merge(df3,how='outer',on='ticker')
    df_temp = df_temp.merge(df4,how='outer',on='ticker')
    
    if index == 1:
        df = df_temp
        index = 2
    else:
        df = df.append(df_temp,ignore_index=True)


# In[ ]:

df = df.merge(df1,how='outer',on=['ticker','tradeDate'])


# In[ ]:

last_dates = {"2015-12-01":"2016-01-04","2016-01-04":"2016-02-01","2016-02-01":"2016-03-01","2016-03-01":"2016-04-01","2016-04-01":"2016-05-03","2016-05-03":"2016-06-01","2016-06-01":"2016-07-01","2016-07-01":"2016-08-01","2016-08-01":"2016-09-01","2016-09-01":"2016-10-10","2016-10-10":"2016-11-01","2016-11-01":"2016-12-01","2016-12-01":"2017-01-03","2017-01-03":"2017-02-03","2017-02-03":"2017-03-01","2017-03-01":"2017-04-05","2017-04-05":"2017-05-02","2017-05-02":"2017-06-01","2017-06-01":"2017-07-03","2017-07-03":"2017-08-01","2017-08-01":"2017-09-01","2017-09-01":"2017-10-09","2017-10-09":"2017-11-01","2017-11-01":"2017-12-01","2017-12-01":"2018-01-02","2018-01-02":"2018-02-01","2018-02-01":"2018-03-01","2018-03-01":"2018-04-02","2018-04-02":"2018-05-02","2018-05-02":"2018-06-01","2018-06-01":"2018-07-02","2018-07-02":"2018-08-01","2018-08-01":"2018-09-03","2018-09-03":"2018-10-08","2018-10-08":"2018-11-01","2018-11-01":"2018-12-03","2018-12-03":"2019-01-02","2019-01-02":"2019-02-01","2019-02-01":"2019-03-01","2019-03-01":"2019-04-01","2019-04-01":"2019-05-06","2019-05-06":"2019-06-03"}
df_lastchg = DataAPI.MktEqumGet(secID=u"",ticker=tickers,monthEndDate=u"",beginDate=u"20151201",endDate=u"20190531",isOpen=u"",field=u"ticker,monthBeginDate,chgPct",pandas="1")

listt = []

for dd in df_lastchg['monthBeginDate']:
    listt.append(last_dates[dd])
    
df_lastchg['tradeDate'] = listt
df_lastchg.pop('monthBeginDate')
df_lastchg.rename(columns={'chgPct':'lastChgPct'},inplace=True)
df.rename(columns={'chgPct':'label'},inplace=True)
df = df_lastchg.merge(df,how='right',on=['ticker','tradeDate'])
#df = df.dropna(how='any')
#df = df.dropna(subset=['industryName1'])
df = df.dropna(thresh=15)
df = df[df['tradeDate'] != 'inf']


# In[ ]:

minvals = df.min().to_dict()
df = df.fillna(value=minvals)
df.to_csv('happyworking.csv',index=False)

